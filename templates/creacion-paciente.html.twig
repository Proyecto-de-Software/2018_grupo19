{% extends 'layout.html.twig' %}

{% block estilos %}
{{parent()}}
<link rel="stylesheet" href="templates/styles/creacion-pacientes.css">
{% endblock %}

{% block links %}
<script src="../vendor/components/jquery/jquery.min.js"></script>
{% endblock %}

{% block contenido %}

<div class="contenido">
    <div class="panel-principal">
        <form id="formulario" class="formulario-principal" {% block accion %}action="index.php?comando=insertar-paciente"{% endblock %} method="post">
            <h3>{% block tituloAccion %}Creando paciente{% endblock %}</h3>
            <div class="label-input">
                <label>Nombre de Paciente:</label>
                <input class="inputf" type="text" name="nombre" value="{% block nombre_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Apellido de Paciente:</label>
                <input class="inputf" type="text" name="apellido" value="{% block apellido_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Fecha de nac.:</label>
                <input class="inputf" type="date" name="fecha_nac" value="{% block fecha_nac_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Lugar de nac.:</label>
                <input class="inputf" type="text" name="lugar_nac" value="{% block lugar_nac_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Partido:</label>
                <select name="partido" id="partidos" required>
                </select>
            </div>
            <div class="label-input">
                <label>Region sanitaria:</label>
                <input id="region_sanitaria_id" class="inputf" type="text" readonly="readonly" name="region_sanitaria_id" value="{% block region_sanitaria_paciente %}{% endblock %}">
            </div>
            <div class="label-input">
                <label>Localidad:</label>
                <select id="localidades" name="localidad_id" value="{% block localidad_paciente %}{% endblock %}" required>
                </select>
            </div>
            <div class="label-input">
                <label>Domicilio:</label>
                <input class="inputf" type="text" name="domicilio" value="{% block domicilio_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Género:</label>
                <select id="generos" name="genero_id" value="{% block genero_paciente %}{% endblock %}" required></select>
            </div>
            <div class="label-input">
                <label>Posee documento:</label>
                <input class="inputf checkb" name="tiene_documento" type="checkbox" value="{% block tiene_documento_paciente %}{% endblock %}">
            </div>
            <div class="label-input">
                <label>Tipo de documento:</label>
                <select id="tipos-doc" name="tipo_doc_id" value="{% block tipo_doc_paciente %}{% endblock %}"></select>
            </div>
            <div class="label-input">
                <label>Nro de documento:</label>
                <input class="inputf" name="numero" type="text" value="{% block numero_paciente %}{% endblock %}">
            </div>
            <div class="label-input">
                <label>Nro de historia clínica:</label>
                <input class="inputf" name="nro_historia_clinica" type="number" value="{% block nro_historia_clinica_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Nro de carpeta:</label>
                <input class="inputf" name="nro_carpeta" type="number" value="{% block nro_carpeta_paciente %}{% endblock %}" required>
            </div>
            <div class="label-input">
                <label>Telefono:</label>
                <input class="inputf" name="tel" type="text" value="{% block tel_paciente %}{% endblock %}">
            </div>
            <div class="label-input">
                <label>Obra social:</label>
                <select id="obras-sociales" name="obra_social_id" value="{% block obra_social_paciente %}{% endblock %}"></select>
            </div>
        </form>
        <button type="submit" form="formulario" class="boton-panel-principal">Guardar</button>
        {% block cargaDeNN %}
        <button class="boton-panel-principal" onclick="location.href='index.php?comando=creacion-paciente-nn'">Cargar como NN</button>
        {% endblock %}
    </div>
</div>

<script type="text/javascript">

$(document).ready(function(){
    obtenerPartidos();
    obtenerGeneros();
    obtenerTiposDeDocumento();
    obtenerObrasSociales();


    //**
    //Event handler para cuando se ingresa un partido o se pone el campo en blanco
    $("#partidos").on("input",function () {
        if ($("#partidos").val()) {
            {% block postCargaDePartidos %}
            actualizarRegionSanitaria();
            actualizarLocalidades();
            {% endblock %}
        } else {
            $("#region_sanitaria_id").val('');
            $('#localidades').empty();
        }
    });
});

function obtenerPartidos() {
    fetch('https://api-referencias.proyecto2018.linti.unlp.edu.ar/partido')
    .then(function(response) {
        response.json().then(function(partidos) {
            partidos.forEach(function(partido) {
                $('<option>').val(partido['id']).text(partido['nombre']).appendTo('#partidos')
            })
        })
    }).then(function(){
        $("#partidos").val("1")
        actualizarLocalidades()
        actualizarRegionSanitaria()
    })
}

function obtenerGeneros() {
    $.get("index.php?comando=obtener-generos",
    function (generos) {
        $.each($.parseJSON(generos),function (index, genero) {$('<option>').val(genero['id']).text(genero['nombre']).appendTo('#generos');})
    })
}

function obtenerTiposDeDocumento() {
    fetch('https://api-referencias.proyecto2018.linti.unlp.edu.ar/tipo-documento')
    .then(function(response) {
        response.json().then(function(tiposDocumentos) {
            tiposDocumentos.forEach(function(tipoDoc) {
                $('<option>').val(tipoDoc['id']).text(tipoDoc['nombre']).appendTo('#tipos-doc')
            })
        })
    })
}

function obtenerObrasSociales() {
    fetch('https://api-referencias.proyecto2018.linti.unlp.edu.ar/obra-social')
    .then(function(response) {
        response.json().then(function(obs) {
            obs.forEach(function(ob) {
                $('<option>').val(ob['id']).text(ob['nombre']).appendTo('#obras-sociales')
            })
        })
    })
}

function actualizarRegionSanitaria() {
    fetch('https://api-referencias.proyecto2018.linti.unlp.edu.ar/partido/' + $('#partidos').val())
    .then(function(response) {
        response.json().then(function(partidos) {
            $('#region_sanitaria_id').val(partidos['region_sanitaria_id'])
        })
    })
}

function actualizarLocalidades() {
    fetch('https://api-referencias.proyecto2018.linti.unlp.edu.ar/localidad/partido/'+($("#partidos").val()))
    .then(function(response) {
        response.json().then(function(localidades) {
            $('#localidades').empty();
            localidades.forEach(function(localidad) {
                $('<option>').val(localidad['id']).text(localidad['nombre']).appendTo('#localidades')
            })
        })
    })
}

</script>

{% endblock %}
