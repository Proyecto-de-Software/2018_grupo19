{% extends 'layout.html.twig' %}

{% block estilos %}
    {{parent()}}
    <link rel="stylesheet" href="templates/styles/estadisticas.css">
{% endblock %}

{% block links %}
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
{% endblock %}

{% block contenido %}

    <div class="graph-container">
        <div class="graph" id="chartContainerGenero"></div>
        <div class="graph" id="chartContainerMotivo"></div>
        <div class="graph" id="chartContainerLocalidad"></div>     
    </div>
    
    <script>
        
        fetch("index.php?comando=obtener-consultas-por-motivo").then(
            function(response){
                response.json().then(
                    function(estadisticas){
                        estadisticas = estadisticas.map(function (estadistica) {
                            return {y:parseFloat(estadistica.cantidad), name:estadistica.motivo}
                        })
                        generarGrafico(estadisticas,'motivo',"chartContainerMotivo")
                    })
            }
        )

        fetch("index.php?comando=obtener-consultas-por-genero").then(
            function(response){
                response.json().then(
                    function(estadisticas){
                        estadisticas = estadisticas.map(function (estadistica) {
                            return {y:parseFloat(estadistica.cantidad), name:estadistica.genero}
                        })
                        generarGrafico(estadisticas,'genero',"chartContainerGenero")
                    })
            }
        )

        fetch("index.php?comando=obtener-consultas-por-localidad").then(
            function(response){
                response.json().then(
                    function(estadisticas){
                        estadisticas = estadisticas.map(function (estadistica) {
                            return {y:parseFloat(estadistica.cantidad), name:estadistica.localidad}
                        })
                        generarGrafico(estadisticas,'localidad',"chartContainerLocalidad")
                    })
            }
        )

        function generarGrafico(estadisticas, titulo, idContenedor){
            console.log(estadisticas);
            // Build the chart
            Highcharts.chart(idContenedor, {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: 'Consultas agrupadas por '+titulo
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Estadisticas',
                    colorByPoint: true,
                    data: estadisticas
                }]
            });
        }

    </script>

{% endblock %}
