{% extends 'layout.html.twig' %}

{% block estilos %}
    {{parent()}}
    <link rel="stylesheet" href="templates/styles/estadisticas.css">
{% endblock %}

{% block links %}
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.min.js"></script>
{% endblock %}

{% block contenido %}

    <div class="graph-container" id="graph-container">
        <div>
            <div class="graph" id="chartContainergenero"></div>
        </div>
        <div>
            <div class="graph" id="chartContainermotivo"></div>
        </div>
        <div>
            <div class="graph" id="chartContainerlocalidad"></div>     
        </div>
    </div>
    
    <script>

        cargarDatos('motivo')
        cargarDatos('genero')
        cargarDatos('localidad')

        function cargarDatos(titulo) {
            fetch("index.php?comando=obtener-consultas-por-"+titulo).then(
                function(response){
                    response.json().then(
                        function(estadisticas){
                            estadisticas = estadisticas.map(function (estadistica) {
                                return {y:parseFloat(estadistica.cantidad), name:`Cantidad agrupadas por ${estadistica[titulo]}: ${estadistica.cantidad}`}
                            })
                            generarGrafico(estadisticas,titulo,"chartContainer"+titulo)
                        })
                }
            )
        }

        function generarGrafico(estadisticas, titulo, idContenedor){
            // Build the chart
            Highcharts.chart(idContenedor, {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie',
                },
                title: {
                    text: 'Consultas agrupadas por '+titulo
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Estadisticas',
                    colorByPoint: true,
                    data: estadisticas
                }]
            });
        }

    </script>

{% endblock %}
